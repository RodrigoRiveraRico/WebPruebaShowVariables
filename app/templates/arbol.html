<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seleccion de covariables</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles.css') }}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default-dark/style.min.css" />

</head>

<body>

    <header>    {{etiqueta_h}}     </header>  

    <h2>Selección de <span class="covariables">covariables</span> y <span class="clase">clase</span>:</h2>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
    <form id="selectVariablesForm" action="/select_variables" method="post">
        <div id="container_SVar">
            <div>
                <label>Selecciona las <span class="covariables">covariables</span>:</label>
                <div id="tree"></div>
                <div id="selectedNodesContainer1"></div>
                <textarea name="selectedVariables1" id="selectedVariables1" rows="4" cols="50" readonly style="display: none;"></textarea>
            </div>
            <div>
                <label>Selecciona la <span class = "clase">clase</span>:</label>
                <div id="tree2"></div>
                <div id="selectedNodesContainer2"></div>
                <textarea name="selectedVariables2" id="selectedVariables2" rows="4" cols="50" readonly style="display: none;"></textarea>
            </div>
        </div>
        <div id="buttonContainer">
        <button id="sendButton" style="display:none;" type="submit">Enviar covariables y clase seleccionadas</button>
        </div>
    </form>
    <script>
        $(function () {
            $.getJSON('/tree_data', function (data) {
                $('#tree').jstree({ 'core': { 'data': data, 
                                            'themes': {   /// Cambiar el tema
                                                'name': 'default', // nombre del tema
                                                'dots': true, // mostrar puntos entre nodos
                                                'icons': false // mostrar iconos junto a los nodos
                                            } } });
                $('#tree2').jstree({ 'core': { 'data': data,
                                            'themes': {   /// Cambiar el tema
                                                'name': 'default', // nombre del tema
                                                'dots': true, // mostrar puntos entre nodos
                                                'icons': false // mostrar iconos junto a los nodos
                                            } } });
            });
        });



        $(function () {
            var selectedNodes = [];
            var selectedNodes2 = [];

            $('#tree').on('select_node.jstree', function (e, data) {
            var node = data.node;
            var tree = $('#tree').jstree();
            
            if (node.children.length) {
                // El nodo tiene hijos, verifica si es penúltimo nivel
                node.children.forEach(function (childId) {
                    var childNode = tree.get_node(childId);
                    if (!childNode.children.length) {
                        // Si el hijo no tiene más hijos, entonces es penúltimo nodo
                        var parentNode = tree.get_node(node.parent);
                        var mainNodeName = getMainNodeName(parentNode);
                        var fullName = mainNodeName + ':' + childNode.text;
                        if (!selectedNodes.includes(fullName)) {
                            selectedNodes.push(fullName);
                        }
                    }
                });
                // Actualizar contenedor después de agregar todos los hijos del penúltimo nodo.
                updateSelectedNodesContainer('#selectedNodesContainer1', selectedNodes, '#selectedVariables1');
            } else {
                // Si el nodo no tiene hijos, se tiene el comportamiento original. 
                var parentNode = tree.get_node(node.parent);
                var mainNodeName = getMainNodeName(parentNode);
                var fullName = mainNodeName + ':' + node.text;
                if (!selectedNodes.includes(fullName)) {
                    selectedNodes.push(fullName);
                    updateSelectedNodesContainer('#selectedNodesContainer1', selectedNodes, '#selectedVariables1');
                }
            }
            });

            // $('#tree').on('select_node.jstree', function (e, data) {
            //     var node = data.node;
            //     if (!node.children.length) {
            //         var parentNode = $('#tree').jstree().get_node(node.parent);
            //         var mainNodeName = getMainNodeName(parentNode);
            //         var fullName = mainNodeName + ':' + node.text;
            //         if (!selectedNodes.includes(fullName)) {
            //             selectedNodes.push(fullName);
            //             updateSelectedNodesContainer('#selectedNodesContainer1', selectedNodes, '#selectedVariables1');
            //         }
            //     }
            // });

            $('#tree2').on('select_node.jstree', function (e, data) {
                var node = data.node;
                if (!node.children.length) {
                    var parentNode = $('#tree2').jstree().get_node(node.parent);
                    var mainNodeName = getMainNodeName(parentNode);
                    var fullName = mainNodeName + ':' + node.text;
                    if (!selectedNodes2.includes(fullName) && selectedNodes2.length < 1) {
                        selectedNodes2.push(fullName);
                        updateSelectedNodesContainer('#selectedNodesContainer2', selectedNodes2, '#selectedVariables2');
                    }
                }
            });

        /*  ------------------ */
        //  $(function () {
        
        //     $("#toggle_dots, #toggle_icons").click(function () {
        
        //         $("#demo1").jstree(this.value);
        
        //     });
        
        //     $("#set_theme1").click(function () {
        
        //         $("#demo1").jstree("set_theme","apple");
        //     });
        //     $("#set_theme2").click(function () {
        //         $("#demo1").jstree("set_theme","default");
        //     });
        //     $("#demo1").jstree({
        //         "themes" : {
        //             "theme" : "default",
        //             "dots" : false,
        //             "icons" : false
        //         },
        //         "plugins" : [ "themes", "html_data" ]
        //     });
        // });
        /*  ------------------ */


            
            function getMainNodeName(node) {
                while (node.parent !== '#') {
                    node = $('#tree').jstree().get_node(node.parent);
                }
                return node.text;
            }

            function updateSelectedNodesContainer(containerSelector, selectedNodes, inputSelector) {
                var container = $(containerSelector);
                container.empty();
                selectedNodes.forEach(function (node, index) {
                    var item = $('<div class="selected-item"></div>').text(node);
                    var button = $('<button class="remove-button">x</button>').click(function () {
                        selectedNodes.splice(index, 1);
                        updateSelectedNodesContainer(containerSelector, selectedNodes, inputSelector);
                    });
                    item.append(button);
                    container.append(item);
                });
                $(inputSelector).val(selectedNodes.join('\n'));
            }

            $('#sendButton').show();
        });
    </script>
</body>
</html>

